<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Simple Sidebar - Start Bootstrap Template</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
      html,body,#wrapper,#page-content-wrapper,#wrapper2{
        background-color:gray;
        height:100%;
      }
      #messages {
        background-color: lightblue;
        height: 80%;
        overflow-y:scroll;
        overflow-x:hidden;
        list-style-type: none;
        margin:0px;
        padding:0px;
      }
      #bottom_strip {
        background-color:wheat;
        height:70px;
      }
      .msg-group {
        padding-right:0px;
      }
      #controls {
        /*margin-top: 5px;*/
        padding-top:12px;
      }
      

    </style>

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Start Bootstrap
                    </a>
                </li>
                <li>
                    <a href="#">Dashboard</a>
                </li>
                <li>
                    <a href="#">Shortcuts</a>
                </li>
                <li>
                   <div class="input-group">
                      <label for="transform_dropdown">Choose a Transform</label>
                      <select class="form-control" id="transform_dropdown"></select>
                    </div>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
                 <li>
                  <span id="branding" ></span>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
          <div id ="wrapper2" class="container-fluid">
            <!-- <div id = "messages_div"> -->
              <ul id = "messages">
              </ul>
            <!-- </div> -->
            <div id = "bottom_strip">
              <div id = "controls">
                <div class = "col-xs-2">
                  <a href="#menu-toggle" class="btn btn-default btn-lg" id="menu-toggle"><span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span> </a>
                </div>
                <div class = "col-xs-10">
                  <div class="input-group input-group-lg">
                    <input id="m" type="text" class="form-control input-lg" autocomplete="off" placeholder="Your Message Here...">
                    <span class="input-group-btn" >
                      <button id="send_button" class="btn btn-info btn-lg" type="button">
                        <span class="glyphicon glyphicon-send" aria-hidden="true"></span> Send
                      </button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>

    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src ="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src = "/socket.io/socket.io.js"></script>
    <script src = "js/facebook.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


<script>

  function SetupFacebook(){
    // For now, control use of the dev version or public version
    // by commenting out one of the two lines below
    //*********************************************
    SetFacebookInitCallback();
    // SetFacebookInitCallbackDev();
    // *********************************************
    LoadFacebookSDK();
  }

  // Here we run a very simple test of the Graph API after login is
// successful.  See statusChangeCallback() for when this call is made.
function FacebookLoggedInCallback() {
  FB.api('/me', function(response) {
    // document.getElementById('status').innerHTML =
      // 'Thanks for logging in, ' + response.name + '!';
    document.facebook.response = response;
    document.facebook.name = response.name;
    document.facebook.id = response.id;
    document.facebook.logged_in = true;
    document.socket.emit("facebook login", response);
  });
}
</script>

    <script>
      
      function SetupSockets(){
        document.socket = io();
        console.log(document.socket);
        // console.log(JSON.stringify(socket));
        document.socket.on('chat message', function(chat_message){
          ChatMessageContainer(chat_message);
        });
        document.socket.on('random name', function(rn){
          document.random_name = rn;
        });
        document.socket.on('ip', function(ip){
          document.ip_address = ip;
        });
        document.socket.on('chatbot message', function(chatbot_message){
          console.log(chatbot_message);
          var msg = ParseChatbotMessage(chatbot_message);
          ChatMessageContainer(msg);
        });
        // document.socket.on('connection message', function(con_msg){
        //   $("#user_dropdown").append("<option value = " + con_msg.user_id + ">" + con_msg.user_name + "</option>");
        // });
        // document.socket.on('disconnection message', function(dis_msg){
        //   $("#user_dropdown").children("option[value='" + dis_msg.user_id + "']").remove();
        // });
        document.socket.on('update users', function(user_list){
          ClearUserDropdown();
          PopulateUserDropdown(user_list);
        });
      }


      function PopulateTransformDropdown(){
        var options = ["None", "Synonymize", "Antonymize", "SmartSynonymize","Spanish","LocalGoogleImages", "Paraphrase", "ServerBingImages", "ServerGoogleImages", "PartsOfSpeech", "Scotranslate"];
        options.forEach(function(option){
          $("#transform_dropdown").append("<option value = " + option +">" + option + "</option>");
        });
        $("#transform_dropdown").change(function(){
          document.transforms = [$("#transform_dropdown option:selected").val()];
        });
      }

      function EnableTransformButton(){
        $("#transform_button").click(function(){
          var transform = $("#transform_dropdown").val();
          document.transforms = [transform];
        });
      }

      function SetupTransforms(){
        document.transforms = [];
        EnableTransformButton();
        PopulateTransformDropdown();
      }

      const EVERYONE_ID = 1;
      const EVERYONE_AND_LAUREN_ID = 2;
      // const JUST_LAUREN_ID = 3;
      function PopulateUserDropdown(user_list){
        AddUserToDropdown(EVERYONE_ID,"Everyone");
        AddUserToDropdown(EVERYONE_AND_LAUREN_ID, "Everyone + Chatbot Lauren");
        // AddUserToDropdown(JUST_LAUREN_ID, "Chatbot Lauren");
        for(var index in user_list){
          var user = user_list[index];
          var name = user.name
          if(user.socket_id == document.socket.id){
            name = name + " (You)";
          }
          AddDisabledUserToDropdown(user.socket_id, name);
        }
      }

      function ClearUserDropdown(){
        $("#user_dropdown").empty();
      }
      function AddUserToDropdown(id,name){
        $("#user_dropdown").append("<option value = " + id + ">" + name + "</option>");
      }
      function AddDisabledUserToDropdown(id,name){
        $("#user_dropdown").append("<option class='disabled' value = " + id + " disabled >" + name + "</option>");
      }

      function ParseChatbotMessage(chat_message){
        var xml_string = chat_message.original_text;
        var xml_doc = $.parseXML(xml_string);
        $xml = $(xml_doc);
        $bot_response = $xml.find("that");
        var bot_response = $bot_response.text();
        console.log(bot_response);
        chat_message.original_text = bot_response;
        return chat_message;
      }

      function RequestRecentChatMessages(){
        document.socket.emit('init');
      }

      $(document).ready(function(){
        // SetupFacebook();
        // SetupGoogleSearch();
        SetupSockets();
        EnableScrollDownOnResize();
        RequestRecentChatMessages();
        EnableSendButton();
        SetupTransforms();
      });
  
      function EnableSendButton(){
        $("#send_button").click(function(){
          HitSend();
        });
        EnableEnterToSend();
      }


      // function EmitChatMessage(chat_message){
      //   document.socket.emit('chat message', chat_message);
      // }
      function HitSend(){
        var input = GetInput();
        ClearInput();
        console.log("sending " + input);
        document.socket.emit('chat message', new ChatMessage(input));
        return false;
      }
      function GetInput(){
        var input = $('#m').val();
        return input;
      }
      // function SendMsg(msg){
      //   EmitChatMessage(new ChatMessage(msg));
      // }
      function SendSplittableMsg(msg){
        EmitSplittableMessage(new ChatMessage(msg));
      }
      function EmitSplittableMessage(splittable){
        document.socket.emit('splittable chat message', splittable);
      }
      function ClearInput(){
        $('#m').val('');
      }
      // function SplitMessage(msg){
      //   var words = msg.split(" ").filter(Boolean);
      //   console.log(msg);
      //   console.log(words);
      //   return words;
      // }
      function EnableEnterToSend(){
        $("#m").keydown(function(event){
          if(event.keyCode == 13) {
            event.preventDefault();
            HitSend();
            return false;
          }
        });
      }




      function ChatMessage(message){
        var directed_at_bot = $("#user_dropdown").val() == EVERYONE_AND_LAUREN_ID;

        this.author_id = GetMyID();
        this.author_facebook_id = GetFacebookID();
        this.author_name = GetMyName();
        this.timestamp = new Date().getTime();
        this.target = (directed_at_bot)? "Everyone" : "Humans";
        this.original_text = message;
        this.is_images = false;
        //transformed_text
        //image_url_lists
        this.transform_list = document.transforms;
        this.one_word_at_a_time = true;
      }

      

      function ScrollDown(){
        var div = $("#messages");
        var height = div.prop("scrollHeight");
        div.scrollTop(height);
      }

      function EnableScrollDownOnResize(){
        $(window).resize(function(){
          ScrollDown();
        })
      }

      function GetMyName(){
        if(document.facebook.logged_in){
          return document.facebook.name;
        }
        else{
          return "Anonymous " + document.random_name;
        }
      }

      function GetFacebookID(){
        if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return undefined;
        }
      }
      function GetMyID(){
       if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return document.ip_address;
        }
      }

      function RandomWord(){
        var requestStr = "http://randomword.setgetgo.com/get.php";
        $.ajax({
            type: "GET",
            url: requestStr,
            dataType: "jsonp",
            jsonpCallback: 'RandomWordComplete'
        });
      }
      function RandomWordComplete(data){
        document.random_word = data.Word;
      }
      RandomWord();

      function ISaid(chat_message){
        var my_id = GetMyID();
        var msg_id = chat_message.author_id;
        return (my_id == msg_id);
      }

      function IsSameSentence(prev_message, next_message){
        return (
          BothExist(prev_message,next_message) &&
          SameAuthor(prev_message,next_message)
          //  &&
          // AreCloseEnough(prev_message,next_message)
            );
      }
      function BothExist(cm1,cm2){
        return(cm1 && cm2);
      }
      function AreCloseEnough(cm1, cm2){
        // times are in ms
        var time1 = cm1.timestamp;
        var time2 = cm2.timestamp;
        return AreWithin(time1,time2,1000);
      }
      function AreWithin(a,b,range){
        var diff = Math.abs(b-a);
        return diff <= range;
      }

      function SameAuthor(cm1,cm2){
        if(!cm1 || !cm2){
          return false;
        }
        var author1 = cm1.author_id;
        var author2 = cm2.author_id;
        return (author1 == author2);
      }

  /* Building Chat Line HTML/CSS */

  function ChatMessageContainer(chat_message){
    // var cur_author = chat_message.author_id;
    var prev_container = $("#messages").children().last();
    // var prev_author = prev_container.attr("name");
    var container;

    if(IsSameSentence(document.prev_chat_message,chat_message)){
      container = prev_container;
    }
    else{
      container = GenerateNewMessageLine();//chat_message);
      $("#messages").append(container);
      container.children().eq(0).append(LabelPicture(chat_message));
      // container.append(Label(chat_message));
    }
    document.prev_chat_message = chat_message;
    container.children().eq(1).append(Msg(chat_message));
    ScrollDown();
  }

  /* Template HTML */

  var GenerateNewMessageLine = function(){
    var line = $("<li class='clearfix' name='line'></li>");
    line.append(GenerateLabelHTML());
    line.append(GenerateMsgGroupHTML());
    return line;
  }

  var GenerateLabelHTML = function(){
    var label = $("<div name='label' class='well col-xs-2' style='background-color:BurlyWood; display:inline-block;'></div>");
    return label;
  }

  var GenerateMsgGroupHTML = function(){
     var msg = $("<div name='msg_group' class='col-xs-10 msg-group'></div>");
     return msg;
  }

  var GenerateMsgHTML = function(){
    var msg = $("<div name='msg'></div>");
    return msg;
  }


  /* Labels */

  function Label(chat_message){
    // var label_text = LabelText(chat_message);
    var label_pic = LabelPicture(chat_message);
    // var label = GenerateLabelHTML();
    // var text = $("<p>").text(label_text);
    // var time = $("<p>").text(new Date(chat_message.timestamp).toLocaleString());
    // label.append(label_pic);

    // label.append(text);
    // label.append(time);
    // return label;
    return label_pic;
  }
  // function LabelText(chat_message){
  //   var time = "(" + chat_message.timestamp + ")";
  //   var author = chat_message.author_name;
  //   var label_text = author;
  //   return label_text;
  // }
  function LabelPicture(chat_message){
    var url;
    if(chat_message.author_facebook_id){
      url = FacebookProfilePicture(chat_message.author_facebook_id);
    }
    else{
      url = "https://robohash.org/"+document.ip_address;
    }
    var pic = $("<img>").attr("src", url).width(50);
    return pic;
  }

  /* Messages */

  var Msg = function(chat_message){
    if(IsTextMessage(chat_message)){
      return TextMsg(chat_message);
    }
    if(IsLocalImageMessage(chat_message)){
      return LocalImageMsg(chat_message);
    }
    if(IsServerImageMessage(chat_message)){
      return ServerImageMsg(chat_message);
    }
  }

  var IsLocalImageMessage = function(chat_message){
    return chat_message.is_images && !chat_message.image_url_lists;
  }
  var IsServerImageMessage = function(chat_message){
    return chat_message.is_images && chat_message.image_url_lists;
  }
  var IsTextMessage = function(chat_message){
    return !chat_message.is_images;
  }

  var TextMsg = function(chat_message){
    var msg = GenerateMsgHTML();
    msg.text(chat_message.transformed_text);
    return msg;
  }

  var ServerImageMsg = function(chat_message){
    var msg = GenerateMsgHTML();
    chat_message["image_url_lists"].forEach(
      function(url_list){
        var cycling_images = CombineImages(url_list);
        msg.append(cycling_images);
      }
    );
    return msg;
  }

  var LocalImageMsg = function(chat_message){
    var msg = GenerateMsgHTML();
    var img_containers = [];
    var words = chat_message.original_text.split(" ");
    words.forEach(function(word,index){
      img_containers[index] = $("<div>");
      img_containers[index].css('display','inline-block');

      GoogleSearch(
        word,
        function(err,google_results){
          var url_list = [];
          google_results.forEach(function(result){
            url_list.push(result.tbUrl);
          });
          img_containers[index].append(CombineImages(url_list));
        }
      );
      msg.append(img_containers[index]);
    });
    return msg;
  }


  /* Displaying Images */

  var CombineImages = function(url_list){
    var container = $("<div>");
    url_list.forEach(
      function(url){
        var img = ResultImage(url);
        container.append(img);
        container.css('display','inline-block');
      }
    );
    CycleThroughImages(container);
    return container;
  }

  function ResultImage(url){
    var img = $("<img>");
    img.on("load", function(){
      ScrollDown();
      img.parent().show();
    });
    
    // img.css('display','inline-block');
    // img.hide();
    img.css('width',150);
    img.css('height',150);
    img.attr('src', url);
    
    return img;
  }

  function CycleThroughImages(container){
    ShowNextImage(container,0);
  }
      
  function ShowNextImage(container,index){
    index = parseInt(index);
    var max = container.children().length;
    // console.log("max: " + max);
    index = (index >= max)? 0 : index;
    ShowOneImage(container,index);
    setTimeout(function(){
      ShowNextImage(container,index+1);
    },3000);
  }
  function ShowOneImage(container,index){
    container.children().hide();
    var index_from_1 = parseInt(index) + 1;
    container.children('img:nth-child('+index_from_1+')').show();
  }
  function ShowAllImages(container){
    container.children().show();
  }

  /* Local Google Images */

  function SetupGoogleSearch(){
    google.load('search', '1');
    google.setOnLoadCallback(function(){
      console.log(google.search.Search);
      google.search.Search.getBranding('branding');
    })
  }
  SetupGoogleSearch();

  var GoogleSearch = function(string, callback){
     // Create an Image Search instance.
    var my_search = new google.search.ImageSearch();
    // Set searchComplete as the callback function when a search is 
    // complete.  The imageSearch object will have results in it.
    my_search.setSearchCompleteCallback(
      this, 
      function(){
        callback(null,my_search.results);
      }
    );
    my_search.setResultSetSize(8);
    my_search.execute(string);
  }

</script>


</body>

</html>
