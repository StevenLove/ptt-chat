<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <div id="branding"  style="float: left;"></div><br />
    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>
    <div id="status">
    </div>

    <div id="messages_container" style="height:500px; overflow: scroll;">
    <ul id="messages"></ul>
    </div>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>


    <!--
      Below we include the Login Button social plugin. This button uses
      the JavaScript SDK to present a graphical Login button that triggers
      the FB.login() function when clicked.
    -->

 





    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src ="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src ="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src = "/socket.io/socket.io.js"></script>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Latest compiled JavaScript -->
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>



<script src = "facebook.js"></script>
<script>

  function SetupFacebook(){
    // For now, control use of the dev version or public version
    // by commenting out one of the two lines below
    //*********************************************
    // SetFacebookInitCallback();
    SetFacebookInitCallbackDev();
    // *********************************************
    LoadFacebookSDK();
  }

  SetupFacebook();
</script>















    <script>
      var socket = io();


      function ChatMessage(message){
        this.msg = message;
        this.author = GetName();
        this.timestamp = new Date().getTime();
      }


      $('form').submit(function(){
        var msg = $('#m').val();
        var chat_message = new ChatMessage(msg);
        console.log(msg);
        console.log(chat_message);
        socket.emit('chat message', chat_message);
        $('#m').val('');
        return false;
      });

      socket.on('chat message', function(chat_message){
        ChatMessageContainer(chat_message);
      });

      function ScrollDown(){
        var div = $("#messages_container");
        var height = div.prop("scrollHeight");
        div.scrollTop(height);
      }

      function GetName(){
        if(document.facebook.name){
          return document.facebook.name;
        }
        else{
          return "Anonymous";
        }
      }

      function Label(chat_message){
        var time = "(" + chat_message.timestamp + ")";
        var author = chat_message.author;
        var label = time + " " + author + ": ";
        return label;
      }
      function ChatMessageContainer(chat_message){
        var img_container = $("<span>");
        var label = Label(chat_message);
        var container = $('<li>');
        container.text(label);
        container.append(img_container);
        GoogleSearch(img_container,chat_message.msg);
        $("#messages").append(container);
      }

      function SetupGoogleSearch(){
        google.load('search', '1');
        google.setOnLoadCallback(function(){
          google.search.Search.getBranding('branding');
        })
        window.imageSearch = {};
      }
      SetupGoogleSearch();

      function searchComplete() {
        // Check that we got results
        if (imageSearch.results && imageSearch.results.length > 0) {
          // Loop through our results, printing them to the page.
          var results = imageSearch.results;
          var container = imageSearch.destination_container;
           for (var i = 0; i < results.length; i++) {
            var result = results[i];
            var url = result.tbUrl;
            var img = ResultImage(url)
            container.append(img);
           }
           // CycleThroughImages(container);
           ShowAllImages(container);
        }
      }

      function ResultImage(url){
        var img = $("<img>");
        img.on("load", function(){
          ScrollDown();
        });
        img.attr('src', url);
        img.hide();
        return img;
      }

      function CycleThroughImages(container){
        ShowNextImage(container,0);
      }
      function ShowNextImage(container,index){
        index = parseInt(index);
        var max = container.children().length;
        // console.log("max: " + max);
        while(index >= max){
          index = index-max;
        }
        ShowOneImage(container,index);
        setTimeout(function(){
          ShowNextImage(container,index+1);
        },2000);
      }
      function ShowOneImage(container,index){
        container.children().hide();
        var index_from_1 = parseInt(index) + 1;
        container.children('img:nth-child('+index_from_1+')').show();
      }
      function ShowAllImages(container){
        container.children().show();
      }


      function GoogleSearch(container, string){
         // Create an Image Search instance.
        imageSearch = new google.search.ImageSearch();

        // Set searchComplete as the callback function when a search is 
        // complete.  The imageSearch object will have results in it.
        imageSearch.setSearchCompleteCallback(this, searchComplete, null);

        imageSearch.setResultSetSize(8);
        imageSearch.destination_container = container;
        imageSearch.execute(string);
        
      }




    </script>













  </body>
</html>