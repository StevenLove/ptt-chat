<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      #controls{ background:wheat; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #messages li:nth-child(even) { background: #ddd;}
    </style>
  </head>
  <body>


    <div id="messages_container" >
    <ul id="messages"></ul>
    </div>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <div id="controls">
      <div id="branding"  style="float: left;"></div><br />
      <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
      </fb:login-button>
      <div id="status">
      </div>
      <div class="col-lg-12 col-xs-12" >
      <div class="input-group">
        <span class="input-group-btn">
          <button id="send_button" class="btn btn-info" type="button">
            <span class="glyphicon glyphicon-send" aria-hidden="true"></span> Send
          </button>
        </span>
        <input id="m" type="text" class="form-control" autocomplete="off" placeholder="Your Message Here...">
      </div>
    </div>
    </div>




    <!--
      Below we include the Login Button social plugin. This button uses
      the JavaScript SDK to present a graphical Login button that triggers
      the FB.login() function when clicked.
    -->

 





    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src ="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src ="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src = "/socket.io/socket.io.js"></script>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">


<!-- Latest compiled JavaScript -->
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>



<script src = "facebook.js"></script>
<script>

  function SetupFacebook(){
    // For now, control use of the dev version or public version
    // by commenting out one of the two lines below
    //*********************************************
    // SetFacebookInitCallback();
    SetFacebookInitCallbackDev();
    // *********************************************
    LoadFacebookSDK();
  }

  SetupFacebook();
</script>















    <script>
      
      function SetupSockets(){
        document.socket = io();
        document.socket.on('chat message', function(chat_message){
          ChatMessageContainer(chat_message);
        });
        document.socket.on('random name', function(rn){
          document.random_name = rn;
        });
        document.socket.on('ip', function(ip){
          document.ip_address = ip;
        })
      }

      function RequestRecentChatMessages(){
        document.socket.emit('init');
      }

      $(document).ready(function(){
        SetupSockets();
        EnableScrollDownOnResize();
        RequestRecentChatMessages();
        EnableSendButton();
      });
  
      function EnableSendButton(){
        $("#send_button").click(function(){
          HitSend();
        });
        EnableEnterToSend();
      }


      function EmitChatMessage(chat_message){
        document.socket.emit('chat message', chat_message);
      }
      function HitSend(){
        var msg = $('#m').val();
        EmitChatMessage(new ChatMessage(msg));
        $('#m').val('');
        return false;
      }
      function EnableEnterToSend(){
        $("#m").keydown(function(event){
          if(event.keyCode == 13) {
            event.preventDefault();
            HitSend();
            return false;
          }
        });
      }



      function ChatMessage(message){
        this.msg = message;
        this.author_name = GetName();
        this.author_facebook_id = GetFacebookID();
        this.author_id = GetID();
        this.timestamp = new Date().toLocaleString();
      }



      

      function ScrollDown(){
        var div = $("body");
        var height = div.prop("scrollHeight");
        div.scrollTop(height);
      }

      function EnableScrollDownOnResize(){
        $(window).resize(function(){
          ScrollDown();
        })
      }

      function GetName(){
        if(document.facebook.logged_in){
          return document.facebook.name;
        }
        else{
          return "Anonymous " + document.random_name;
        }
      }

      function GetFacebookID(){
        if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return undefined;
        }
      }
      function GetID(){
       if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return document.ip_address;
        }
      }

      function RandomWord(){
        var requestStr = "http://randomword.setgetgo.com/get.php";
        $.ajax({
            type: "GET",
            url: requestStr,
            dataType: "jsonp",
            jsonpCallback: 'RandomWordComplete'
        });
      }
      function RandomWordComplete(data){
        document.random_word = data.Word;
      }
      RandomWord();

      function Label(chat_message){
        var label_text = LabelText(chat_message);
        var label_pic = LabelPicture(chat_message);
        var label = $("<div  class='well col-md-2 col-sm-2' name='label'>");
        var text = $("<p>").text(label_text);
        var time = $("<p>").text(chat_message.timestamp);
        var id = $("<p>").text(chat_message.author_id);
        label.append(text);
        label.append(time);
        label.append(id);
        label.append(label_pic);
        label.css('display','inline-block');
        label.css('margin-right',20);
        return label;
      }
      function LabelText(chat_message){
        var time = "(" + chat_message.timestamp + ")";
        var author = chat_message.author_name;
        var label_text = author;
        return label_text;
      }
      function LabelPicture(chat_message){
        var url = FacebookProfilePicture(chat_message.author_facebook_id);
        var pic = $("<img>").attr("src", url);
        return pic;
      }



      function ChatLine(chat_message){
        var container = $('<li class="clearfix">');
        var line = $('<div name = "line">');
        var content = $('<div name = "content">');
        container.append(line);
        var label = Label(chat_message);
        var images = $('<div name="chatline_images" class="col-md-8 col-sm-8">').css('display','inline-block');

        if(ISaid(chat_message)){
          line.append(label);
          line.append(images);
        }
        else{
          // line.append($("<div class='col-md-2'>"));
          line.append(label);
          line.append(images);
          // line.append(images).css("float","left");
          // line.append(label).css("float","right");
          // line.css("float","right");
        }

        // container.append($("<div>").attr("class","clearfix"));
        container.attr("name",chat_message.author_id);
        return container;
      }

      function ISaid(chat_message){
        var my_id = GetID();
        var msg_id = chat_message.author_id;
        console.log("my id " + my_id + ". msg id : " + msg_id);
        return (my_id == msg_id);
      }


      function ChatMessageContainer(chat_message){
        var cur_author = chat_message.author_id;
        var prev_container = $("#messages").children().last();
        var prev_author = prev_container.attr("name");
        var container;
        if(prev_author && prev_author == cur_author){
          container = prev_container;
        }
        else{
          container = ChatLine(chat_message);
          $("#messages").append(container);
        }


        var img_container = $("<div>");
        img_container.css('display','inline-block');
        // img_container.css('height',150);
        // img_container.css('width',150);
        img_container.hide();

        container.find("[name='chatline_images']").append(img_container);

        GoogleSearch(img_container,chat_message.msg);
      }





      function ResultImage(url){
        var img = $("<img>");
        img.on("load", function(){
          ScrollDown();
          img.parent().show();
        });
        
        // img.css('display','inline-block');
        img.hide();
        img.css('width',150);
        img.css('height',150);
        img.attr('src', url);
        
        return img;
      }


      function CycleThroughImages(container){
        ShowNextImage(container,0);
      }
      function ShowNextImage(container,index){
        index = parseInt(index);
        var max = container.children().length;
        // console.log("max: " + max);
        while(index >= max){
          index = index-max;
        }
        ShowOneImage(container,index);
        setTimeout(function(){
          ShowNextImage(container,index+1);
        },3000);
      }
      function ShowOneImage(container,index){
        container.children().hide();
        var index_from_1 = parseInt(index) + 1;
        container.children('img:nth-child('+index_from_1+')').show();
      }
      function ShowAllImages(container){
        container.children().show();
      }

      function WholeNumberMax(a,b){
        if(typeof a !== 'number'){
          a = 0;
        }
        if(typeof b !== 'number'){
          b = 0;
        }
        return Math.max(a,b);
      }


</script>











<script>

      SetupGoogleSearch();

      function SetupGoogleSearch(){
        google.load('search', '1');
        google.setOnLoadCallback(function(){
          google.search.Search.getBranding('branding');
        })
      }

      function UpdateContainerDimensions(container, img){
        var img_h = img.get(0).naturalHeight;
        var old_height = container.prop("max_height");
        var new_height = WholeNumberMax(old_height,img_h);
        container.prop("max_height",new_height);
        container.height(new_height);
        // console.log(new_height);
        // console.log(container.height());

        var img_w = img.get(0).naturalWidth;
        var old_width = container.prop("max_width");
        var new_width = WholeNumberMax(old_width,img_w);
        container.prop("max_width",new_width);
        container.css("width", new_width);
      }

      function GoogleSearch(container, string){
         // Create an Image Search instance.
        var my_search = new google.search.ImageSearch();

        // Set searchComplete as the callback function when a search is 
        // complete.  The imageSearch object will have results in it.
        my_search.setSearchCompleteCallback(
          this, 
          function(){
            if (my_search.results && my_search.results.length > 0) {
              // Loop through our results, printing them to the page.
              var results = my_search.results;
              var container = my_search.destination_container;
               for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var url = result.tbUrl;
                var img = ResultImage(url)
                container.append(img);
               }
               CycleThroughImages(container);
            }
          },
          null
        );

        my_search.setResultSetSize(8);
        my_search.destination_container = container;
        my_search.execute(string);
        
      }

    </script>













  </body>
</html>