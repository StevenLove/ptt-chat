<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      #controls{ background:wheat; padding: 3px; position: fixed; bottom: 0; width: 100%; height: 120px;}
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0;}
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #messages li:nth-child(even) { background: #ddd;}

      html, body{
        height:100%;
      }

    </style>
  </head>
  <body>


    <div id="messages_container" style="height:80%; overflow-y:scroll" >
    <ul id="messages"></ul>
    </div>

    <table border="0" cellspacing="1" cellpadding="0">
  <tr>
    <td>
      <a href="http://www.whoohoo.co.uk/"><img src="http://www.whoohoo.co.uk/external.gif" border="0"></a><br>
    </td>
  </tr>
  <tr>
    <td>
      <form method="POST" action="http://www.whoohoo.co.uk/external.asp">
        <textarea wrap="soft" name="string" rows="9" cols="20"></textarea><br><br>
        <input type="image" SRC="http://www.whoohoo.co.uk/translate.gif" value="Translate" border="0">
        <input type="hidden" name="topic" value="translator">
        <input type="hidden" name="translator" value="scottie">
        <input type="hidden" name="siteurl" value="http://www.uofantarctica.com">
      </form>
    </td>
  </tr>
</table>

    <div id="controls">
      <span id="branding" style="float:left;" ></span>
      <div id="accessories" style="float:right;">
        

        <fb:login-button scope="public_profile,email" size="xlarge" onlogin="checkLoginState();">
        </fb:login-button>

        <span id="status">
        </span>

        <div class="input-group input-group-lg" style="float:right;">
          <label for="user_dropdown">Send To</label>
          <select class="form-control" id="user_dropdown"></select>
        </div>
      </div>
      <div class="col-lg-12 col-xs-12">
      <div class="input-group ">
        <span class="input-group-btn" >
          <button id="send_button" class="btn btn-info btn-lg" type="button">
            <span class="glyphicon glyphicon-send" aria-hidden="true"></span> Send
          </button>
        </span>
        <input id="m" type="text" class="form-control input-lg" autocomplete="off" placeholder="Your Message Here...">
      </div>
    </div>
    </div>




    <!--
      Below we include the Login Button social plugin. This button uses
      the JavaScript SDK to present a graphical Login button that triggers
      the FB.login() function when clicked.
    -->

 






    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src ="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src ="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src = "/socket.io/socket.io.js"></script>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">


<!-- Latest compiled JavaScript -->
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>



<script src = "facebook.js"></script>
<script>

  function SetupFacebook(){
    // For now, control use of the dev version or public version
    // by commenting out one of the two lines below
    //*********************************************
    SetFacebookInitCallback();
    // SetFacebookInitCallbackDev();
    // *********************************************
    LoadFacebookSDK();
  }

  SetupFacebook();

  // Here we run a very simple test of the Graph API after login is
// successful.  See statusChangeCallback() for when this call is made.
function FacebookLoggedInCallback() {
  FB.api('/me', function(response) {
    document.getElementById('status').innerHTML =
      'Thanks for logging in, ' + response.name + '!';
    document.facebook.response = response;
    document.facebook.name = response.name;
    document.facebook.id = response.id;
    document.facebook.logged_in = true;
    document.socket.emit("facebook login", response);
  });
}
</script>















    <script>
      
      function SetupSockets(){
        document.socket = io();
        document.socket.on('chat message', function(chat_message){
          ChatMessageContainer(chat_message);
        });
        document.socket.on('random name', function(rn){
          document.random_name = rn;
        });
        document.socket.on('ip', function(ip){
          document.ip_address = ip;
        });
        document.socket.on('chatbot message', function(chatbot_message){
          console.log(chatbot_message);
          var msg = ParseChatbotMessage(chatbot_message);
          ChatMessageContainer(msg);
        });
        // document.socket.on('connection message', function(con_msg){
        //   $("#user_dropdown").append("<option value = " + con_msg.user_id + ">" + con_msg.user_name + "</option>");
        // });
        // document.socket.on('disconnection message', function(dis_msg){
        //   $("#user_dropdown").children("option[value='" + dis_msg.user_id + "']").remove();
        // });
        document.socket.on('update users', function(user_list){
          ClearUserDropdown();
          PopulateUserDropdown(user_list);
        });
      }

      const EVERYONE_ID = 1;
      const EVERYONE_AND_LAUREN_ID = 2;
      // const JUST_LAUREN_ID = 3;
      function PopulateUserDropdown(user_list){
        AddUserToDropdown(EVERYONE_ID,"Everyone");
        AddUserToDropdown(EVERYONE_AND_LAUREN_ID, "Everyone + Chatbot Lauren");
        // AddUserToDropdown(JUST_LAUREN_ID, "Chatbot Lauren");
        for(var index in user_list){
          var user = user_list[index];
          var name = user.name
          if(user.socket_id == document.socket.id){
            name = name + " (You)";
          }
          AddDisabledUserToDropdown(user.socket_id, name);
        }
      }

      function ClearUserDropdown(){
        $("#user_dropdown").empty();
      }
      function AddUserToDropdown(id,name){
        $("#user_dropdown").append("<option value = " + id + ">" + name + "</option>");
      }
      function AddDisabledUserToDropdown(id,name){
        $("#user_dropdown").append("<option class='disabled' value = " + id + " disabled >" + name + "</option>");
      }

      function ParseChatbotMessage(chat_message){
        var xml_string = chat_message.original_text;
        var xml_doc = $.parseXML(xml_string);
        $xml = $(xml_doc);
        $bot_response = $xml.find("that");
        var bot_response = $bot_response.text();
        console.log(bot_response);
        chat_message.original_text = bot_response;
        return chat_message;
      }

      function RequestRecentChatMessages(){
        document.socket.emit('init');
      }

      $(document).ready(function(){
        SetupSockets();
        EnableScrollDownOnResize();
        RequestRecentChatMessages();
        EnableSendButton();
      });
  
      function EnableSendButton(){
        $("#send_button").click(function(){
          HitSend();
        });
        EnableEnterToSend();
      }


      // function EmitChatMessage(chat_message){
      //   document.socket.emit('chat message', chat_message);
      // }
      function HitSend(){
        var input = GetInput();
        ClearInput();
        // var words = SplitMessage(input);
        // for(var index in words){
        //   var word = words[index];
        //   SendMsg(word);
        // }
        // SendSplittableMsg(input);
        document.socket.emit('chat message', new ChatMessage(input));
        return false;
      }
      function GetInput(){
        var input = $('#m').val();
        return input;
      }
      // function SendMsg(msg){
      //   EmitChatMessage(new ChatMessage(msg));
      // }
      function SendSplittableMsg(msg){
        EmitSplittableMessage(new ChatMessage(msg));
      }
      function EmitSplittableMessage(splittable){
        document.socket.emit('splittable chat message', splittable);
      }
      function ClearInput(){
        $('#m').val('');
      }
      // function SplitMessage(msg){
      //   var words = msg.split(" ").filter(Boolean);
      //   console.log(msg);
      //   console.log(words);
      //   return words;
      // }
      function EnableEnterToSend(){
        $("#m").keydown(function(event){
          if(event.keyCode == 13) {
            event.preventDefault();
            HitSend();
            return false;
          }
        });
      }




      function ChatMessage(message){
        var directed_at_bot = $("#user_dropdown").val() == EVERYONE_AND_LAUREN_ID;

        this.author_id = GetMyID();
        this.author_facebook_id = GetFacebookID();
        this.author_name = GetMyName();
        this.timestamp = new Date().getTime();
        this.target = (directed_at_bot)? "Everyone" : "Humans";
        this.original_text = message;
        //transformed_text
        //image_url_lists
        this.transform_list = ["Spanish", "Reverse", "Split", "Reverse", "Picture"];
        this.one_word_at_a_time = true;
      }

      

      function ScrollDown(){
        var div = $("#messages_container");
        var height = div.prop("scrollHeight");
        div.scrollTop(height);
      }

      function EnableScrollDownOnResize(){
        $(window).resize(function(){
          ScrollDown();
        })
      }

      function GetMyName(){
        if(document.facebook.logged_in){
          return document.facebook.name;
        }
        else{
          return "Anonymous " + document.random_name;
        }
      }

      function GetFacebookID(){
        if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return undefined;
        }
      }
      function GetMyID(){
       if(document.facebook.logged_in){
          return document.facebook.id;
        }
        else{
          return document.ip_address;
        }
      }

      function RandomWord(){
        var requestStr = "http://randomword.setgetgo.com/get.php";
        $.ajax({
            type: "GET",
            url: requestStr,
            dataType: "jsonp",
            jsonpCallback: 'RandomWordComplete'
        });
      }
      function RandomWordComplete(data){
        document.random_word = data.Word;
      }
      RandomWord();

      function Label(chat_message){
        var label_text = LabelText(chat_message);
        var label_pic = LabelPicture(chat_message);
        var label = $("<div  class='well col-md-2 col-sm-2' name='label'>");
        var text = $("<p>").text(label_text);
        var time = $("<p>").text(new Date(chat_message.timestamp).toLocaleString());
        // var id = $("<p>").text(chat_message.author_id);
        label.append(text);
        label.append(time);
        // label.append(id);
        label.append(label_pic);
        label.css('display','inline-block');
        label.css('margin-right',20);
        return label;
      }
      function LabelText(chat_message){
        var time = "(" + chat_message.timestamp + ")";
        var author = chat_message.author_name;
        var label_text = author;
        return label_text;
      }
      function LabelPicture(chat_message){
        var url = FacebookProfilePicture(chat_message.author_facebook_id);
        var pic = $("<img>").attr("src", url);
        return pic;
      }



      function ChatLine(chat_message){
        var container = $('<li class="clearfix">');
        var line = $('<div name = "line">');
        var content = $('<div name = "content">');
        container.append(line);
        var label = Label(chat_message);
        var images = $('<div name="chatline_images" class="col-md-8 col-sm-8">').css('display','inline-block');

        if(ISaid(chat_message)){
          line.append(label);
          line.append(images);
        }
        else{
          // line.append($("<div class='col-md-2'>"));
          line.append(label);
          line.append(images);
          // line.append(images).css("float","left");
          // line.append(label).css("float","right");
          // line.css("float","right");
        }

        // container.append($("<div>").attr("class","clearfix"));
        container.attr("name",chat_message.author_id);
        return container;
      }

      function ISaid(chat_message){
        var my_id = GetMyID();
        var msg_id = chat_message.author_id;
        return (my_id == msg_id);
      }

      function IsSameSentence(prev_message, next_message){
        return (
          BothExist(prev_message,next_message) &&
          SameAuthor(prev_message,next_message) &&
          AreCloseEnough(prev_message,next_message)
            );
      }
      function BothExist(cm1,cm2){
        return(cm1 && cm2);
      }
      function AreCloseEnough(cm1, cm2){
        // times are in ms
        var time1 = cm1.timestamp;
        var time2 = cm2.timestamp;
        return AreWithin(time1,time2,1000);
      }
      function AreWithin(a,b,range){
        var diff = Math.abs(b-a);
        return diff <= range;
      }

      function SameAuthor(cm1,cm2){
        if(!cm1 || !cm2){
          return false;
        }
        var author1 = cm1.author_id;
        var author2 = cm2.author_id;
        return (author1 == author2);
      }

      function ChatMessageContainer(chat_message){
        // var cur_author = chat_message.author_id;
        var prev_container = $("#messages").children().last();
        // var prev_author = prev_container.attr("name");
        var container;

        // if(prev_author && prev_author == cur_author){
        //   container = prev_container;
        // }
        // else{
        //   container = ChatLine(chat_message);
        //   $("#messages").append(container);
        // }
        // console.log(document.prev_chat_message);
        // console.log(chat_message);
        // console.log("----");

        if(IsSameSentence(document.prev_chat_message,chat_message)){
          container = prev_container;
        }
        else{
          container = ChatLine(chat_message);
          $("#messages").append(container);
        }
        document.prev_chat_message = chat_message;


        



        var cb = function(data){
          // console.log(data);
           var img_container = $("<div>");
            container.find("[name='chatline_images']").append(img_container);
            img_container.css('display','inline-block');
          img_container.append(data);
          img_container.append("&nbsp;");
          // GoogleSearch(img_container,data);
        }
        console.log(chat_message.transformed_text);
        // TurnSpanish(chat_message.original_text,cb);


        if(chat_message.image_url_lists.length > 0){
          for(var i in chat_message.image_url_lists){
            var img_container = $("<div>");
            container.find("[name='chatline_images']").append(img_container);
            img_container.css('display','inline-block');
            var img_url_list = chat_message.image_url_lists[i];
            for(var j in img_url_list){
              var img_url = img_url_list[j];
              img_container.append(ResultImage(img_url));
            }
            CycleThroughImages(img_container);
          }
        }
        else{
          cb(chat_message.transformed_text);
        }
      }


      function TurnSpanish(text, callback){
        $.ajax({
            type: "GET",
            url: "http://localhost:8286/?mode=translate&from=en&to=es&text=" + text,
            success: callback
        });
      }





      function ResultImage(url){
        var img = $("<img>");
        img.on("load", function(){
          ScrollDown();
          img.parent().show();
        });
        
        // img.css('display','inline-block');
        // img.hide();
        img.css('width',150);
        img.css('height',150);
        img.attr('src', url);
        
        return img;
      }


      function CycleThroughImages(container){
        ShowNextImage(container,0);
      }
      function ShowNextImage(container,index){
        index = parseInt(index);
        var max = container.children().length;
        // console.log("max: " + max);
        while(index >= max){
          index = index-max;
        }
        ShowOneImage(container,index);
        setTimeout(function(){
          ShowNextImage(container,index+1);
        },3000);
      }
      function ShowOneImage(container,index){
        container.children().hide();
        var index_from_1 = parseInt(index) + 1;
        container.children('img:nth-child('+index_from_1+')').show();
      }
      function ShowAllImages(container){
        container.children().show();
      }

      function WholeNumberMax(a,b){
        if(typeof a !== 'number'){
          a = 0;
        }
        if(typeof b !== 'number'){
          b = 0;
        }
        return Math.max(a,b);
      }


</script>











<script>

      SetupGoogleSearch();

      function SetupGoogleSearch(){
        google.load('search', '1');
        google.setOnLoadCallback(function(){
          google.search.Search.getBranding('branding');
        })
      }

      function UpdateContainerDimensions(container, img){
        var img_h = img.get(0).naturalHeight;
        var old_height = container.prop("max_height");
        var new_height = WholeNumberMax(old_height,img_h);
        container.prop("max_height",new_height);
        container.height(new_height);
        // console.log(new_height);
        // console.log(container.height());

        var img_w = img.get(0).naturalWidth;
        var old_width = container.prop("max_width");
        var new_width = WholeNumberMax(old_width,img_w);
        container.prop("max_width",new_width);
        container.css("width", new_width);
      }

      function GoogleSearch(container, string){
         // Create an Image Search instance.
        var my_search = new google.search.ImageSearch();

        // Set searchComplete as the callback function when a search is 
        // complete.  The imageSearch object will have results in it.
        my_search.setSearchCompleteCallback(
          this, 
          function(){
            if (my_search.results && my_search.results.length > 0) {
              // Loop through our results, printing them to the page.
              var results = my_search.results;
              var container = my_search.destination_container;
               for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var url = result.tbUrl;
                var img = ResultImage(url)
                container.append(img);
               }
               CycleThroughImages(container);
            }
          },
          null
        );

        my_search.setResultSetSize(8);
        my_search.destination_container = container;
        my_search.execute(string);
        
      }

    </script>













  </body>
</html>